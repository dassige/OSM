<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="resources/favicon.ico">
    <title id="pageTitle">Email Templates - FENZ OSM</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>
    <style>
        .container { max-width: 950px; margin: 0 auto; padding-top: 40px; padding-bottom: 60px; }
        .back-btn { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #fff; background-color: #343a40; width: 45px; height: 45px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: all 0.2s ease; }
        .back-btn:hover { background-color: #23272b; transform: translateY(-2px); }

        /* TABS */
        .tab-container { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; font-weight: bold; color: #666; border-top-left-radius: 6px; border-top-right-radius: 6px; transition: all 0.2s; background: #f8f9fa; margin-right: 2px; border: 1px solid #ddd; border-bottom: none; }
        .tab:hover { background-color: #e9ecef; }
        .tab.active { background-color: #fff; color: #007bff; border-bottom: 2px solid #fff; margin-bottom: -2px; }
        .tab-content { display: none; background: #fff; padding: 25px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px; position: relative; }
        .tab-content.active { display: block; }

        /* ACTIONS BAR inside Tab */
        .template-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 10; }
        .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; color: white; background-color: #6c757d; transition: background 0.2s; }
        .btn-sm:hover { background-color: #5a6268; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.95em; color: #333; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .palette-container { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; padding: 10px; background: #eef2f5; border: 1px solid #dee2e6; border-radius: 4px; align-items: center; max-width: 100%; }
        /* Fix for overlap in specific tabs where palette is the first element */
        #tab-newuser .palette-container,
        #tab-reset .palette-container,
        #tab-delete .palette-container {
            margin-top: 40px;
        }

        .palette-label { font-size: 12px; font-weight: bold; color: #666; margin-right: 5px; text-transform: uppercase; }
        .draggable-item { background-color: #fff; border: 1px solid #adb5bd; border-radius: 12px; padding: 4px 12px; font-family: monospace; font-weight: 600; color: #495057; cursor: grab; user-select: none; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .draggable-item:hover { background-color: #007bff; color: white; border-color: #007bff; }
        .draggable-item:active { cursor: grabbing; }

        .btn-container { text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-save { background-color: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-save:hover { background-color: #218838; }
        
        /* Checkbox Group */
        .checkbox-group { display: flex; align-items: center; background: #e8f0fe; padding: 10px; border-radius: 4px; border: 1px solid #b8d4fe; color: #1a73e8; font-weight: bold; margin-bottom: 20px; margin-top: 40px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
    </style>
</head>
<body>
    <a href="/" class="back-btn" title="Back to Dashboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></a>

    <div class="container">
        <h1 id="pageHeader">Email Templates</h1>
        
        <input type="file" id="importFile" accept=".json" style="display: none;">

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('skills')">Expiring Skills</div>
            <div class="tab" onclick="switchTab('newuser')">New User</div>
            <div class="tab" onclick="switchTab('reset')">Password Reset</div>
            <div class="tab" onclick="switchTab('delete')">Delete Account</div>
        </div>

        <form id="templateForm">
            
            <div id="tab-skills" class="tab-content active">
                <div class="template-actions">
                    <button type="button" class="btn-sm" onclick="triggerImport('skills')">Import</button>
                    <button type="button" class="btn-sm" onclick="exportTemplate('skills')">Export</button>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="skillsFilterNoUrl">
                    <label for="skillsFilterNoUrl" style="margin:0; display:inline;">Include only skills with Form URL?</label>
                </div>

                <div class="palette-container">
                    <span class="palette-label">Drag variables:</span>
                    <div class="draggable-item" draggable="true" data-val="appname">AppName</div>
                    <div class="draggable-item" draggable="true" data-val="name">Member Name</div>
                    <div class="draggable-item" draggable="true" data-val="email">Member Email</div>
                </div>
                <div class="form-group"><label>Sender (From)</label><input type="text" id="skillsFrom" class="droppable-input" placeholder='"{{appname}}" <noreply@example.com>'></div>
                <div class="form-group"><label>Subject</label><input type="text" id="skillsSubject" class="droppable-input" placeholder="{{appname}}: Expiring Skills"></div>
                <div class="form-group"><label>Intro Body</label><textarea id="skillsIntro" class="rich-editor"></textarea></div>
                
                <hr style="margin: 20px 0; border:0; border-top:1px dashed #ccc;">
                
                <div style="display: flex; flex-direction: column; gap: 30px;">
                    
                    <div style="flex: 1; width: 100%;">
                        <label style="font-weight:bold; color: #007bff;">Repeated Skill Row (With URL)</label>
                        <p style="font-size: 12px; color: #666; margin-top: -5px; margin-bottom: 8px;">Used when the skill has a Form URL configured.</p>
                        
                        <div class="palette-container">
                            <span class="palette-label">Row Variables:</span>
                            <div class="draggable-item" draggable="true" data-val="skill">Skill Name</div>
                            <div class="draggable-item" draggable="true" data-val="date">Expiry Date</div>
                            <div class="draggable-item" draggable="true" data-val="critical">Critical Label</div>
                            <div class="draggable-item" draggable="true" data-val="url">Form URL</div>
                        </div>

                        <textarea id="skillsRow" class="rich-editor"></textarea>
                    </div>

                    <div style="flex: 1; width: 100%;">
                        <label style="font-weight:bold; color: #6c757d;">Repeated Skill Row (No URL)</label>
                        <p style="font-size: 12px; color: #666; margin-top: -5px; margin-bottom: 8px;">Used when no Form URL is available (unless filtered out).</p>
                        
                        <div class="palette-container">
                            <span class="palette-label">Row Variables:</span>
                            <div class="draggable-item" draggable="true" data-val="skill">Skill Name</div>
                            <div class="draggable-item" draggable="true" data-val="date">Expiry Date</div>
                            <div class="draggable-item" draggable="true" data-val="critical">Critical Label</div>
                            <div class="draggable-item" draggable="true" data-val="url">Form URL</div>
                        </div>

                        <textarea id="skillsRowNoUrl" class="rich-editor"></textarea>
                    </div>
                </div>
            </div>

            <div id="tab-newuser" class="tab-content">
                <div class="template-actions">
                    <button type="button" class="btn-sm" onclick="triggerImport('newuser')">Import</button>
                    <button type="button" class="btn-sm" onclick="exportTemplate('newuser')">Export</button>
                </div>
                <div class="palette-container">
                    <span class="palette-label">Variables:</span>
                    <div class="draggable-item" draggable="true" data-val="appname">AppName</div>
                    <div class="draggable-item" draggable="true" data-val="name">User Name</div>
                    <div class="draggable-item" draggable="true" data-val="email">Email</div>
                    <div class="draggable-item" draggable="true" data-val="password" style="border-color:#28a745; color:#28a745;">Password</div>
                </div>
                <div class="form-group"><label>Sender (From)</label><input type="text" id="newUserFrom" class="droppable-input"></div>
                <div class="form-group"><label>Subject</label><input type="text" id="newUserSubject" class="droppable-input"></div>
                <div class="form-group"><label>Email Body</label><textarea id="newUserBody" class="rich-editor"></textarea></div>
            </div>

            <div id="tab-reset" class="tab-content">
                <div class="template-actions">
                    <button type="button" class="btn-sm" onclick="triggerImport('reset')">Import</button>
                    <button type="button" class="btn-sm" onclick="exportTemplate('reset')">Export</button>
                </div>
                <div class="palette-container">
                    <span class="palette-label">Variables:</span>
                    <div class="draggable-item" draggable="true" data-val="appname">AppName</div>
                    <div class="draggable-item" draggable="true" data-val="email">Email</div>
                    <div class="draggable-item" draggable="true" data-val="password" style="border-color:#28a745; color:#28a745;">New Password</div>
                </div>
                <div class="form-group"><label>Sender (From)</label><input type="text" id="resetFrom" class="droppable-input"></div>
                <div class="form-group"><label>Subject</label><input type="text" id="resetSubject" class="droppable-input"></div>
                <div class="form-group"><label>Email Body</label><textarea id="resetBody" class="rich-editor"></textarea></div>
            </div>

            <div id="tab-delete" class="tab-content">
                <div class="template-actions">
                    <button type="button" class="btn-sm" onclick="triggerImport('delete')">Import</button>
                    <button type="button" class="btn-sm" onclick="exportTemplate('delete')">Export</button>
                </div>
                <div class="palette-container">
                    <span class="palette-label">Variables:</span>
                    <div class="draggable-item" draggable="true" data-val="appname">AppName</div>
                    <div class="draggable-item" draggable="true" data-val="name">User Name</div>
                    <div class="draggable-item" draggable="true" data-val="email">Email</div>
                </div>
                <div class="form-group"><label>Sender (From)</label><input type="text" id="deleteFrom" class="droppable-input"></div>
                <div class="form-group"><label>Subject</label><input type="text" id="deleteSubject" class="droppable-input"></div>
                <div class="form-group"><label>Email Body</label><textarea id="deleteBody" class="rich-editor"></textarea></div>
            </div>

            <div class="btn-container">
                <button type="submit" class="btn-save">Save All Templates</button>
            </div>
        </form>
    </div>

    <script>
        let currentImportType = null;

        // Init UI Config
        fetch('/ui-config').then(r=>r.json()).then(c=>{ 
            if(c.loginTitle) document.getElementById('pageTitle').innerText = "Templates - "+c.loginTitle; 
            if(c.appBackground) document.body.style.backgroundImage=`url('${c.appBackground}')`; 
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Find index to set active tab
            const tabs = ['skills', 'newuser', 'reset', 'delete'];
            document.querySelectorAll('.tab')[tabs.indexOf(tabId)].classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        // --- TinyMCE Setup with Chip Support ---
        
        // [UPDATED] Robust DOM-based replacement to avoid breaking attributes
        function textToChips(html) {
            if (!html) return '';
            // Use DOM parsing to avoid touching attributes (like href)
            const div = document.createElement('div');
            div.innerHTML = html;

            const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false);
            const nodesToReplace = [];

            while (walker.nextNode()) {
                const node = walker.currentNode;
                // Only target text nodes containing variables
                if (node.nodeValue && node.nodeValue.match(/{{[a-zA-Z0-9_]+}}/)) {
                    nodesToReplace.push(node);
                }
            }

            nodesToReplace.forEach(node => {
                const fragment = document.createDocumentFragment();
                // Split by {{var}} but keep the delimiter for reconstruction
                const parts = node.nodeValue.split(/({{[a-zA-Z0-9_]+}})/g);
                
                parts.forEach(part => {
                    // Check if this part is strictly a variable
                    if (part.match(/^{{[a-zA-Z0-9_]+}}$/)) {
                        const varName = part.replace(/[{}]/g, '');
                        const span = document.createElement('span');
                        span.className = 'mceNonEditable chip';
                        span.setAttribute('data-val', varName);
                        span.textContent = part;
                        fragment.appendChild(span);
                    } else if (part !== '') {
                        fragment.appendChild(document.createTextNode(part));
                    }
                });
                
                node.parentNode.replaceChild(fragment, node);
            });

            return div.innerHTML;
        }

        function chipsToText(html) {
            if (!html) return '';
            const temp = document.createElement('div');
            temp.innerHTML = html;
            // Convert spans back to text
            temp.querySelectorAll('.chip').forEach(span => {
                span.replaceWith(`{{${span.getAttribute('data-val')}}}`);
            });
            return temp.innerHTML;
        }

        tinymce.init({
            selector: '.rich-editor',
            height: 300,
            menubar: true,
            promotion: false,
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media template link anchor codesample | ltr rtl',
            content_style: `
                body { font-family:Helvetica,Arial,sans-serif; font-size:14px }
                .chip { background-color: #e2e6ea; border: 1px solid #ccc; border-radius: 12px; padding: 2px 8px; margin: 0 2px; font-family: monospace; color: #333; cursor: default; }
            `,
            setup: function(editor) {
                editor.on('drop', function(e) {
                    const content = e.dataTransfer.getData('text/html');
                    if (content && content.includes('data-val')) {
                        e.preventDefault();
                        editor.insertContent(content);
                    }
                });
            }
        });

        // --- Drag & Drop Logic ---
        document.querySelectorAll('.draggable-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                const val = item.getAttribute('data-val');
                const text = `{{${val}}}`;
                e.dataTransfer.setData('text/plain', text); // For Inputs
                const html = `<span class="mceNonEditable chip" data-val="${val}">${text}</span>`;
                e.dataTransfer.setData('text/html', html); // For TinyMCE
            });
        });

        document.querySelectorAll('.droppable-input').forEach(input => {
            input.addEventListener('dragover', e => e.preventDefault());
            input.addEventListener('drop', e => {
                e.preventDefault();
                const text = e.dataTransfer.getData('text/plain');
                if(text) {
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    const val = input.value;
                    input.value = val.substring(0, start) + text + val.substring(end);
                }
            });
        });

        // --- Import / Export Logic ---

        function exportTemplate(type) {
            let data = {};
            
            if (type === 'skills') {
                data = {
                    from: document.getElementById('skillsFrom').value,
                    subject: document.getElementById('skillsSubject').value,
                    intro: chipsToText(tinymce.get('skillsIntro').getContent()),
                    row: chipsToText(tinymce.get('skillsRow').getContent()),
                    // New Fields
                    rowNoUrl: chipsToText(tinymce.get('skillsRowNoUrl').getContent()),
                    filterOnlyWithUrl: document.getElementById('skillsFilterNoUrl').checked
                };
            } else {
                // Generic logic for newuser, reset, delete
                const prefix = (type === 'newuser') ? 'newUser' : type; // Handle camelCase map if needed
                data = {
                    from: document.getElementById(prefix + 'From').value,
                    subject: document.getElementById(prefix + 'Subject').value,
                    body: chipsToText(tinymce.get(prefix + 'Body').getContent())
                };
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template_${type}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function triggerImport(type) {
            currentImportType = type;
            document.getElementById('importFile').value = '';
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !currentImportType) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = JSON.parse(evt.target.result);
                    
                    if (currentImportType === 'skills') {
                        if(data.from) document.getElementById('skillsFrom').value = data.from;
                        if(data.subject) document.getElementById('skillsSubject').value = data.subject;
                        if(data.intro) tinymce.get('skillsIntro').setContent(textToChips(data.intro));
                        if(data.row) tinymce.get('skillsRow').setContent(textToChips(data.row));
                        // New Fields
                        if(data.rowNoUrl) tinymce.get('skillsRowNoUrl').setContent(textToChips(data.rowNoUrl));
                        if(data.filterOnlyWithUrl !== undefined) document.getElementById('skillsFilterNoUrl').checked = data.filterOnlyWithUrl;
                    } else {
                        const prefix = (currentImportType === 'newuser') ? 'newUser' : currentImportType;
                        if(data.from) document.getElementById(prefix + 'From').value = data.from;
                        if(data.subject) document.getElementById(prefix + 'Subject').value = data.subject;
                        if(data.body) tinymce.get(prefix + 'Body').setContent(textToChips(data.body));
                    }
                    alert(`Template for '${currentImportType}' imported successfully!`);
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        // --- Load & Save ---
        async function loadData() {
            const res = await fetch('/api/preferences');
            const prefs = await res.json();

            // 1. Skills
            document.getElementById('skillsFrom').value = prefs.emailFrom || '';
            document.getElementById('skillsSubject').value = prefs.emailSubject || '';
            if(prefs.emailIntro) tinymce.get('skillsIntro').setContent(textToChips(prefs.emailIntro));
            if(prefs.emailRow) tinymce.get('skillsRow').setContent(textToChips(prefs.emailRow));
            
            // New Skills Fields
            if(prefs.emailRowNoUrl) tinymce.get('skillsRowNoUrl').setContent(textToChips(prefs.emailRowNoUrl));
            document.getElementById('skillsFilterNoUrl').checked = prefs.emailOnlyWithUrl || false;

            // 2. Helper to load JSON configs
            const loadTab = (key, prefix) => {
                if(prefs[key]) {
                    try {
                        const data = JSON.parse(prefs[key]);
                        document.getElementById(prefix + 'From').value = data.from || '';
                        document.getElementById(prefix + 'Subject').value = data.subject || '';
                        if(data.body) tinymce.get(prefix + 'Body').setContent(textToChips(data.body));
                    } catch(e) {}
                }
            };

            loadTab('tpl_new_user', 'newUser');
            loadTab('tpl_reset_password', 'reset');
            loadTab('tpl_delete_user', 'delete');
        }

        document.getElementById('templateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Helper to get data
            const getTab = (prefix) => ({
                from: document.getElementById(prefix + 'From').value,
                subject: document.getElementById(prefix + 'Subject').value,
                body: chipsToText(tinymce.get(prefix + 'Body').getContent())
            });

            // 1. Skills (Save as legacy keys for backward compat)
            const skillsIntro = chipsToText(tinymce.get('skillsIntro').getContent());
            const skillsRow = chipsToText(tinymce.get('skillsRow').getContent());
            const skillsRowNoUrl = chipsToText(tinymce.get('skillsRowNoUrl').getContent());
            
            // Batch updates
            const updates = [
                { key: 'emailFrom', value: document.getElementById('skillsFrom').value },
                { key: 'emailSubject', value: document.getElementById('skillsSubject').value },
                { key: 'emailIntro', value: skillsIntro },
                { key: 'emailRow', value: skillsRow },
                
                // New Fields
                { key: 'emailRowNoUrl', value: skillsRowNoUrl },
                { key: 'emailOnlyWithUrl', value: document.getElementById('skillsFilterNoUrl').checked },
                
                { key: 'tpl_new_user', value: JSON.stringify(getTab('newUser')) },
                { key: 'tpl_reset_password', value: JSON.stringify(getTab('reset')) },
                { key: 'tpl_delete_user', value: JSON.stringify(getTab('delete')) }
            ];

            for(const u of updates) {
                await fetch('/api/preferences', { 
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(u) 
                });
            }

            // Logging event
            await fetch('/api/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'Email Templates',
                    title: 'Updated Email Templates',
                    payload: { fields: ['skills', 'new_user', 'reset', 'delete', 'filter_settings'] }
                })
            });

            alert("All templates saved successfully.");
        });

        // Delay init to allow TinyMCE to load
        setTimeout(loadData, 1000);

    </script>
    <script src="help.js"></script>
</body>
</html>