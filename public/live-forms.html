<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="resources/favicon.ico">
    <title id="pageTitle">Live Forms Management - FENZ OSM</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding-top: 40px; padding-bottom: 40px; }
        h1 { text-align: center; margin-bottom: 30px; }

        /* Filter Toolbar */
        .filter-bar {
            background-color: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            flex: 1 1 150px; /* Grow: 1, Shrink: 1, Basis: 150px */
            min-width: 150px; 
        }
        
        /* [UPDATED] Date Groups: Larger basis and higher grow factor to stay equal */
        .filter-group-date { 
            flex: 2 1 300px; 
            min-width: 300px; 
        }

        .filter-group label { font-size: 13px; font-weight: bold; color: var(--text-muted); }
        
        .filter-select, .filter-date {
            padding: 8px; border: 1px solid var(--border-color);
            border-radius: 4px; background-color: var(--input-bg);
            color: var(--text-main); 
            box-sizing: border-box;
            height: 38px; /* Force consistent height */
        }
        
        /* [NEW] Container for the two date inputs */
        .date-range-container {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        /* [NEW] Force inputs to share space equally */
        .date-range-container .filter-date {
            width: 0;   /* CSS Flexbox trick: allow shrinking below content size if needed */
            flex: 1;    /* Grow equally */
        }

        .filter-select { width: 100%; }

        .filter-actions { display: flex; gap: 10px; margin-left: auto; }
        
        .btn-filter, .btn-reset {
            padding: 8px 16px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; color: white;
            white-space: nowrap; height: 38px;
        }
        .btn-filter { background-color: var(--primary); }
        .btn-reset { background-color: #6c757d; }

        /* Table */
        .table-wrapper { background: var(--bg-card); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        th { background-color: var(--bg-header); color: var(--text-header); cursor: pointer; user-select: none; white-space: nowrap; }
        th:hover { background-color: #454d55; }
        
        /* Status Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-open { background-color: #17a2b8; color: white; }
        .status-submitted { background-color: #28a745; color: white; }
        .status-disabled { background-color: #6c757d; color: white; }

        /* Actions */
        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-muted); transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.1); color: var(--primary); }
        .btn-icon.delete:hover { color: #dc3545; }

        /* Mobile */
        @media screen and (max-width: 768px) {
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-actions { width: 100%; justify-content: space-between; margin-left: 0; }
            .btn-filter, .btn-reset { flex: 1; }
            .filter-group-date { min-width: 100%; flex: 1 1 auto; }
        }
    </style>
</head>

<body>
    <div id="demoBanner" class="demo-banner">
        DEMO VERSION <span style="font-weight:normal;">(<a href="demo/demo_osm_dasboard.html" target="_blank"
                style="color:inherit; text-decoration:underline;">View Source HTML</a>)</span>
    </div>

    <a href="/" class="back-btn" title="Back to Dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>

    <div class="container">
        <h1 id="pageHeader">Live Forms Management</h1>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Status</label>
                <select id="filterStatus" class="filter-select">
                    <option value="">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="submitted">Submitted</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Member</label>
                <select id="filterMember" class="filter-select"><option value="">All Members</option></select>
            </div>
            <div class="filter-group">
                <label>Skill</label>
                <select id="filterSkill" class="filter-select"><option value="">All Skills</option></select>
            </div>
            
            <div class="filter-group filter-group-date">
                <label>Sent Date</label>
                <div class="date-range-container">
                    <input type="date" id="filterSentStart" class="filter-date">
                    <input type="date" id="filterSentEnd" class="filter-date">
                </div>
            </div>

            <div class="filter-group filter-group-date">
                <label>Submitted Date</label>
                <div class="date-range-container">
                    <input type="date" id="filterSubStart" class="filter-date">
                    <input type="date" id="filterSubEnd" class="filter-date">
                </div>
            </div>

            <div class="filter-actions">
                <button onclick="loadData()" class="btn-filter">Apply</button>
                <button onclick="resetFilters()" class="btn-reset">Reset</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="liveFormsTable">
                <thead>
                    <tr>
                        <th onclick="handleSort('member_name')">Member <span id="icon-member_name"></span></th>
                        <th onclick="handleSort('skill_name')">Skill <span id="icon-skill_name"></span></th>
                        <th onclick="handleSort('form_sent_datetime')">Sent Date <span id="icon-form_sent_datetime"></span></th>
                        <th onclick="handleSort('form_submitted_datetime')">Submitted <span id="icon-form_submitted_datetime"></span></th>
                        <th onclick="handleSort('form_status')">Status <span id="icon-form_status"></span></th>
                        <th style="text-align:center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-btn" onclick="closeModal('statusModal')">&times;</span>
            <h2>Update Status</h2>
            <p><strong>Member:</strong> <span id="editMember"></span></p>
            <p><strong>Skill:</strong> <span id="editSkill"></span></p>
            <input type="hidden" id="editId">
            
            <div class="form-group" style="margin-top:20px;">
                <label>New Status</label>
                <select id="editStatusSelect" class="filter-select">
                    <option value="open">Open</option>
                    <option value="submitted">Submitted</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button onclick="saveStatus()" class="btn-filter" style="width:100%;">Save Changes</button>
            </div>
        </div>
    </div>

    <button onclick="scrollToTop()" id="scrollTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
    </button>

    <script src="utils.js"></script>
    <script src="toast.js"></script>
    <script src="theme.js"></script>
    <script src="help.js"></script>
    <script>
        let currentData = [];
        let currentSort = { column: 'form_sent_datetime', order: 'desc' };

        async function init() {
            // UI Config
            try {
                const c = await (await fetch('/ui-config')).json();
                if (c.loginTitle) document.getElementById('pageTitle').innerText = "Live Forms - " + c.loginTitle;
                if (c.appBackground) document.body.style.backgroundImage = `url('${c.appBackground}')`;
                if (c.appMode === 'demo') document.getElementById('demoBanner').style.display = 'block';
            } catch(e){}

            // Load Filters (Members/Skills)
            try {
                const mRes = await fetch('/api/members');
                const members = await mRes.json();
                const mSel = document.getElementById('filterMember');
                members.forEach(m => mSel.innerHTML += `<option value="${m.id}">${m.name}</option>`);

                const sRes = await fetch('/api/skills');
                const skills = await sRes.json();
                const sSel = document.getElementById('filterSkill');
                skills.forEach(s => sSel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            } catch(e){}

            loadData();
        }

        async function loadData() {
            const params = new URLSearchParams();
            const getVal = (id) => document.getElementById(id).value;
            
            if(getVal('filterStatus')) params.append('status', getVal('filterStatus'));
            if(getVal('filterMember')) params.append('memberId', getVal('filterMember'));
            if(getVal('filterSkill')) params.append('skillId', getVal('filterSkill'));
            if(getVal('filterSentStart')) params.append('sentStart', getVal('filterSentStart'));
            if(getVal('filterSentEnd')) params.append('sentEnd', getVal('filterSentEnd'));
            // Submitted Date Filters
            if(getVal('filterSubStart')) params.append('subStart', getVal('filterSubStart'));
            if(getVal('filterSubEnd')) params.append('subEnd', getVal('filterSubEnd'));

            document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';
            
            try {
                const res = await fetch(`/api/live-forms?${params.toString()}`);
                if (!res.ok) throw new Error("Failed to load");
                currentData = await res.json();
                applySort();
            } catch (e) {
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${e.message}</td></tr>`;
            }
        }

        function resetFilters() {
            document.querySelectorAll('select, input').forEach(el => el.value = '');
            loadData();
        }

        function handleSort(col) {
            if (currentSort.column === col) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = col;
                currentSort.order = 'asc';
            }
            applySort();
        }

        function applySort() {
            currentData.sort((a, b) => {
                const valA = (a[currentSort.column] || '').toString().toLowerCase();
                const valB = (b[currentSort.column] || '').toString().toLowerCase();
                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (currentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#666;">No records found.</td></tr>';
                return;
            }

            currentData.forEach(row => {
                const sentDate = new Date(row.form_sent_datetime).toLocaleDateString() + ' ' + new Date(row.form_sent_datetime).toLocaleTimeString();
                const subDate = row.form_submitted_datetime 
                    ? new Date(row.form_submitted_datetime).toLocaleDateString() 
                    : '<span style="color:#ccc;">-</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.member_name || 'Unknown'}</td>
                    <td>${row.skill_name || 'Unknown'}</td>
                    <td style="font-size:0.9em;">${sentDate}</td>
                    <td style="font-size:0.9em;">${subDate}</td>
                    <td><span class="status-badge status-${row.form_status}">${row.form_status}</span></td>
                    <td style="text-align:center; white-space:nowrap;">
                        <button class="btn-icon" onclick="openEdit('${row.id}', '${row.member_name}', '${row.skill_name}', '${row.form_status}')" title="Edit Status">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn-icon delete" onclick="deleteRecord('${row.id}')" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Actions
        function openEdit(id, member, skill, status) {
            document.getElementById('editId').value = id;
            document.getElementById('editMember').textContent = member;
            document.getElementById('editSkill').textContent = skill;
            document.getElementById('editStatusSelect').value = status;
            document.getElementById('statusModal').style.display = 'block';
        }

        async function saveStatus() {
            const id = document.getElementById('editId').value;
            const status = document.getElementById('editStatusSelect').value;
            
            try {
                const res = await fetch(`/api/live-forms/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    closeModal('statusModal');
                    loadData();
                    showToast("Status updated", "success");
                } else throw new Error("Update failed");
            } catch (e) { showToast(e.message, "error"); }
        }

        // [UPDATED] Delete with Detailed Confirmation
        async function deleteRecord(id) {
            const row = currentData.find(r => r.id == id);
            const info = row 
                ? `Member: ${row.member_name}\nSkill: ${row.skill_name}\nSent: ${new Date(row.form_sent_datetime).toLocaleDateString()}` 
                : 'this record';
            
            if (!await confirmAction("Delete Record", `Are you sure you want to delete this form?\n\n${info}\n\nThis cannot be undone.`)) return;
            
            try {
                await fetch(`/api/live-forms/${id}`, { method: 'DELETE' });
                loadData();
                showToast("Record deleted", "success");
            } catch (e) { showToast("Delete failed", "error"); }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = (e) => { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }
        
        const scrollTopBtn = document.getElementById("scrollTopBtn");
        window.onscroll = function () { if (scrollTopBtn) scrollTopBtn.style.display = (window.scrollY > 200) ? "flex" : "none"; };
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        init();
    </script>
</body>
</html>