<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="resources/favicon.ico">
    <title id="pageTitle">Skills Management - FENZ OSM</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            position: relative;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding-top: 40px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }


        .table-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .help-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }

        .btn-icon.edit {
            color: #007bff;
        }

        .btn-icon.edit:hover {
            color: #0056b3;
        }

        .btn-icon.delete {
            color: #dc3545;
        }

        .btn-icon.delete:hover {
            color: #bd2130;
        }

        .btn-icon.info {
            color: #17a2b8;
            padding: 4px;
            margin-right: 4px;
        }

        .btn-icon.info:hover {
            color: #117a8b;
            transform: scale(1.1);
        }

        .help-label {
            font-size: 13px;
            color: #666;
            cursor: pointer;
        }

        .help-container {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .help-container:hover .help-label {
            text-decoration: underline;
            color: #17a2b8;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close-btn:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }

        .cb-col {
            width: 40px;
            text-align: center;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        th.sortable:hover {
            background-color: #23272b;
        }

        .th-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sort-icon {
            font-size: 12px;
            margin-left: 8px;
            opacity: 0.5;
        }

        .sort-icon.active {
            opacity: 1;
            color: #4db8ff;
        }

        /* CHIPS STYLING */
        .palette-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            padding: 8px;
            background: #eef2f5;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            align-items: center;
        }

        .palette-label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            margin-right: 4px;
            text-transform: uppercase;
        }

        .draggable-item {
            background-color: #fff;
            border: 1px solid #adb5bd;
            border-radius: 12px;
            padding: 2px 10px;
            font-family: monospace;
            font-weight: 600;
            color: #495057;
            cursor: grab;
            user-select: none;
            font-size: 11px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .draggable-item:hover {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .draggable-item:active {
            cursor: grabbing;
        }

        /* [NEW] TOGGLE SWITCH CSS */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
            vertical-align: middle;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: #28a745;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #28a745;
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="demoBanner" class="demo-banner">
        DEMO VERSION <span style="font-weight:normal;">(<a href="demo/demo_osm_dasboard.html" target="_blank"
                style="color:inherit; text-decoration:underline;">View Source HTML</a>)</span>
    </div>

    <a href="/" class="back-btn" title="Back to Dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>

    <div class="container">
        <h1 id="pageHeader">Manage Skills</h1>
        <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">

        <div id="tableContainer" style="display: block;">
            <div class="table-toolbar">
                <button id="bulkDeleteBtn" onclick="deleteSelected()" class="btn-danger"
                    style="display: none; margin-right: auto;">Delete Selected</button>
                <button onclick="exportToCSV()" class="btn-secondary">Export CSV</button>
                <button onclick="openOsmImportModal()" class="btn-secondary"
                    style="background-color: #17a2b8; color: white;">Import from OSM</button>
                <button onclick="document.getElementById('csvInput').click()" class="btn-success">Import CSV</button>
                <button onclick="openModal()" class="btn-primary">Add Skill</button>
            </div>
            <div class="help-bar">
                <div class="help-container" onclick="openHelpModal()" title="Click for CSV format details">
                    <button class="btn-icon info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                    </button>
                    <span class="help-label">CSV Format Help</span>
                </div>
            </div>

            <table id="manageSkillsTable">
                <thead>
                    <tr>
                        <th class="cb-col"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>

                        <th style="width: 70px; text-align: center;">Enabled</th>

                        <th class="sortable" onclick="handleSort('name')">
                            <div class="th-content">Skill Name <span id="icon-name" class="sort-icon"></span></div>
                        </th>
                        <th class="sortable" onclick="handleSort('critical_skill')">
                            <div class="th-content">Critical <span id="icon-critical_skill" class="sort-icon"></span>
                            </div>
                        </th>
                        <th>Form URL</th>
                        <th style="width: 100px; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="skillsTableBody"></tbody>
            </table>
        </div>
    </div>

    <button onclick="scrollToTop()" id="scrollTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
    </button>

    <div id="skillModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('skillModal')">&times;</span>
            <h2 id="modalTitle">Add Skill</h2>
            <form id="skillForm">
                <input type="hidden" id="skillId">
                <div class="form-group">
                    <label>Skill Name (Exact Match)</label>
                    <input type="text" id="name" required placeholder="e.g. OI (IS1) - Operational Safety">
                </div>

                <div class="form-group">
                    <label>Google Form URL (Optional)</label>
                    <div class="palette-container">
                        <span class="palette-label">Drag to Insert:</span>
                        <div class="draggable-item" draggable="true" data-val="member-name">Member Name</div>
                        <div class="draggable-item" draggable="true" data-val="member-email">Member Email</div>
                    </div>
                    <textarea id="url" rows="4"
                        placeholder="https://docs.google.com/forms/...?entry.123={{member-name}}"
                        style="resize:vertical;"></textarea>

                    <small style="display:block; color:#888; font-size:0.8em; margin-top:4px;">Drag chips above into the
                        box to pre-fill form fields.</small>
                </div>

                <div style="display:flex; gap:20px;">
                    <div class="form-group">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="enabled" checked style="width:auto; margin-right:10px;"> Enabled
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="critical_skill" style="width:auto; margin-right:10px;"> Critical
                            Skill
                        </label>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeModal('skillModal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('helpModal')">&times;</span>
            <h2>CSV File Format</h2>
            <p><strong>Required:</strong> <code>name</code></p>
            <p><strong>Optional:</strong> <code>url</code>, <code>critical_skill</code>, <code>enabled</code></p>
            <div class="code-block">name,url,critical_skill,enabled
                "OI (IS1)",https://forms...{{member-name}},true,true
                "OI (G9)",,0,false</div>
            <br><button onclick="closeModal('helpModal')" class="btn-primary" style="width: 100%">Close</button>
        </div>
    </div>

    <div id="osmImportModal" class="modal">
        <div class="modal-content" style="width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <span class="close-btn" onclick="closeModal('osmImportModal')">&times;</span>
            <h2 id="osmModalTitle">Import Skills from OSM</h2>

            <div
                style="background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em; color: #555;">
                <strong>Note:</strong> This operation scans the OSM Dashboard and will import only the skills that are
                <u>not yet in your table</u>.
            </div>

            <div id="osmLoading" style="text-align: center; padding: 20px; display: none;">
                <div class="spinner" style="display:inline-block; border-top-color:#333; margin-bottom: 10px;"></div>
                <div>Scanning Dashboard...</div>
            </div>

            <div id="osmListContainer"
                style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 20px; min-height: 100px; display: none;">
                <ul id="osmSkillList" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>

            <div id="osmActions" style="text-align: right; display: none;">
                <button type="button" onclick="closeModal('osmImportModal')" class="btn-secondary">Cancel</button>
                <button type="button" onclick="confirmOsmImport()" class="btn-success">Confirm Import</button>
            </div>
        </div>
    </div>

    <script>
        let currentSkills = [];
        let currentSort = { column: 'name', order: 'asc' };
        const ICON_ASC = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
        const ICON_DESC = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>';
        const ICON_NONE = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg>';

        async function initPage() {
            try {
                const uiRes = await fetch('/ui-config');
                if (uiRes.ok) {
                    const uiConfig = await uiRes.json();
                    if (uiConfig.loginTitle) {
                        document.getElementById('pageTitle').innerText = "Skills Management - " + uiConfig.loginTitle;
                        document.getElementById('pageHeader').innerText = "Manage Skills - " + uiConfig.loginTitle;
                    }
                    if (uiConfig.appBackground) document.body.style.backgroundImage = `url('${uiConfig.appBackground}')`;

                    // [NEW] Demo Banner
                    if (uiConfig.appMode === 'demo') {
                        document.getElementById('demoBanner').style.display = 'block';
                    }
                }
                const prefRes = await fetch('/api/user-preferences');
                if (prefRes.ok) {
                    const prefs = await prefRes.json();
                    if (prefs.sortSkillsPage) currentSort = prefs.sortSkillsPage;
                }
            } catch (e) { }
            await reloadSkills();
            setupDragAndDrop();
        }

        // --- DRAG & DROP LOGIC ---
        function setupDragAndDrop() {
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const val = item.getAttribute('data-val');
                    const text = `{{${val}}}`;
                    e.dataTransfer.setData('text/plain', text);
                });
            });

            const urlInput = document.getElementById('url');
            urlInput.addEventListener('dragover', e => e.preventDefault());
            urlInput.addEventListener('drop', e => {
                e.preventDefault();
                const text = e.dataTransfer.getData('text/plain');
                if (text) {
                    const start = urlInput.selectionStart;
                    const end = urlInput.selectionEnd;
                    const val = urlInput.value;
                    urlInput.value = val.substring(0, start) + text + val.substring(end);
                    urlInput.focus();
                    const newPos = start + text.length;
                    urlInput.setSelectionRange(newPos, newPos);
                }
            });
        }

        async function reloadSkills() {
            try {
                const res = await fetch('/api/skills');
                if (!res.ok) throw new Error(res.status);
                currentSkills = await res.json();
                applySort();
            } catch (err) {
                document.getElementById('skillsTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Error: ${err.message}</td></tr>`;
            }
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'asc';
            }
            fetch('/api/user-preferences', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'sortSkillsPage', value: currentSort }) });
            applySort();
        }
        function applySort() {
            currentSkills.sort((a, b) => {
                const valA = (a[currentSort.column] || '').toString().toLowerCase();
                const valB = (b[currentSort.column] || '').toString().toLowerCase();
                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            updateHeaderIcons();
            renderTable();
        }

        function updateHeaderIcons() {
            ['name', 'critical_skill'].forEach(col => {
                const icon = document.getElementById(`icon-${col}`);
                if (icon) { icon.innerHTML = ICON_NONE; icon.classList.remove('active'); }
            });
            const active = document.getElementById(`icon-${currentSort.column}`);
            if (active) { active.innerHTML = currentSort.order === 'asc' ? ICON_ASC : ICON_DESC; active.classList.add('active'); }
        }

        function renderTable() {
            const tbody = document.getElementById('skillsTableBody');
            tbody.innerHTML = '';
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkDeleteButton();
            if (currentSkills.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#666;">No skills found.</td></tr>`;
                return;
            }
            currentSkills.forEach((s, index) => {
                let displayUrl = s.url;
                if (displayUrl) {
                    displayUrl = displayUrl
                        .replace(/{{member-name}}/g, encodeURIComponent("TEST MEMBER"))
                        .replace(/{{member-email}}/g, encodeURIComponent("test@example.com"));
                }

                const urlDisplay = s.url ? `<a href="${displayUrl}" target="_blank" style="color:#007bff;text-decoration:none;">Link</a>` : `<span style="color:#999; font-style:italic;">No Link</span>`;
                const tr = document.createElement('tr');
                // Opacity style for disabled row
                const rowStyle = s.enabled ? '' : 'opacity: 0.6; background-color: #f9f9f9;';
                tr.style = rowStyle;

                tr.innerHTML = `
                    <td class="cb-col"><input type="checkbox" class="skill-checkbox" value="${s.id}" onchange="updateBulkDeleteButton()"></td>
                    
                    <td style="text-align: center;">
                        <label class="switch">
                            <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleSkillEnabled(${s.id}, this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>

                    <td>${s.name}</td>
                    <td style="text-align:center;">${s.critical_skill ? '<b style="color:red;">Yes</b>' : 'No'}</td>
                    <td>${urlDisplay}</td>
                    <td style="text-align: center;">
                        <button class="btn-icon edit" onclick="editSkillByIndex(${index})" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                        <button class="btn-icon delete" onclick="deleteSkill(${s.id})" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        async function toggleSkillEnabled(id, newState) {
            const skill = currentSkills.find(s => s.id == id);
            if (!skill) return;
            skill.enabled = newState;
            try {
                await fetch(`/api/skills/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(skill)
                });
                renderTable(); // Update styles/opacity
            } catch (e) {
                showToast('Failed to update status', 'error');
                skill.enabled = !newState; // Revert
                renderTable();
            }
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.skill-checkbox').forEach(cb => cb.checked = checked);
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const count = document.querySelectorAll('.skill-checkbox:checked').length;
            const btn = document.getElementById('bulkDeleteBtn');
            btn.style.display = count > 0 ? 'block' : 'none';
            btn.textContent = `Delete Selected (${count})`;
        }

        async function deleteSelected() {
            const ids = Array.from(document.querySelectorAll('.skill-checkbox:checked')).map(cb => cb.value);
            if (!ids.length) return;
            if (confirm(`Delete ${ids.length} skills?`)) {
                await fetch('/api/skills/bulk-delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
                reloadSkills();
            }
        }

        const skillModal = document.getElementById('skillModal');
        const form = document.getElementById('skillForm');
        function openModal() {
            document.getElementById('modalTitle').textContent = "Add Skill";
            document.getElementById('skillId').value = "";
            form.reset();
            // Default to Enabled = True
            document.getElementById('enabled').checked = true;
            skillModal.style.display = 'block';
        }
        function editSkillByIndex(index) {
            const s = currentSkills[index];
            document.getElementById('modalTitle').textContent = "Edit Skill";
            document.getElementById('skillId').value = s.id;
            document.getElementById('name').value = s.name;
            document.getElementById('url').value = s.url;
            document.getElementById('critical_skill').checked = s.critical_skill;
            document.getElementById('enabled').checked = s.enabled;
            skillModal.style.display = 'block';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openHelpModal() { document.getElementById('helpModal').style.display = 'block'; }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('skillId').value;
            const data = {
                name: document.getElementById('name').value,
                url: document.getElementById('url').value,
                critical_skill: document.getElementById('critical_skill').checked,
                enabled: document.getElementById('enabled').checked
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/skills/${id}` : '/api/skills';
            await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            closeModal('skillModal');
            reloadSkills();
        });

        async function deleteSkill(id) {
            if (confirm('Delete this skill?')) { await fetch(`/api/skills/${id}`, { method: 'DELETE' }); reloadSkills(); }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
            input.value = '';
        }

        async function processCSV(csv) {
            const lines = csv.split(/\r\n|\n/);
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            if (!headers.includes('name')) { showToast('Invalid CSV', 'error'); return; }
            const skills = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const vals = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                const obj = {};
                headers.forEach((h, idx) => obj[h] = vals[idx]);
                if (obj.name) {
                    obj.critical_skill = (obj.critical_skill === 'true' || obj.critical_skill === '1');
                    // Handle import enable logic if column exists, else default true
                    if (obj.enabled !== undefined) {
                        obj.enabled = (obj.enabled === 'true' || obj.enabled === '1');
                    } else {
                        obj.enabled = true;
                    }
                    skills.push(obj);
                }
            }
            if (skills.length > 0 && confirm(`Import ${skills.length} skills?`)) {
                await fetch('/api/skills/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(skills) });
                reloadSkills();
            }
        }

        async function exportToCSV() {
            if (!currentSkills || currentSkills.length === 0) { showToast("No skills to export.", "warning"); return; }
            const headers = ['name', 'url', 'critical_skill', 'enabled'];
            const rows = currentSkills.map(skill => {
                const rowData = {
                    name: skill.name,
                    url: skill.url,
                    critical_skill: skill.critical_skill ? '1' : '0',
                    enabled: skill.enabled ? '1' : '0'
                };
                return headers.map(header => {
                    let val = String(rowData[header] || '');
                    if (val.search(/("|,|\n)/g) >= 0) val = `"${val.replace(/"/g, '""')}"`;
                    return val;
                }).join(',');
            });
            const csvContent = [headers.join(',')].concat(rows).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "skills_export.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            try {
                await fetch('/api/logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'Skills',
                        title: 'Exported skills list',
                        payload: { count: currentSkills.length }
                    })
                });
            } catch (e) { console.error("Logging failed", e); }
        }

        /* [OSM Import Logic] */
        let discoveredSkills = [];

        async function openOsmImportModal() {
            const modal = document.getElementById('osmImportModal');
            const loading = document.getElementById('osmLoading');
            const listContainer = document.getElementById('osmListContainer');
            const actions = document.getElementById('osmActions');
            const list = document.getElementById('osmSkillList');

            list.innerHTML = '';
            listContainer.style.display = 'none';
            actions.style.display = 'none';
            loading.style.display = 'block';
            modal.style.display = 'block';

            try {
                const res = await fetch('/api/skills/discover');
                if (!res.ok) throw new Error((await res.json()).error || "Failed to scan");

                discoveredSkills = await res.json();
                loading.style.display = 'none';

                if (discoveredSkills.length === 0) {
                    listContainer.style.display = 'block';
                    listContainer.innerHTML = '<p style="text-align:center; color:#666; padding-top:20px;">No new unique skills found.</p>';
                    actions.style.display = 'block';
                    actions.querySelector('.btn-success').disabled = true;
                } else {
                    listContainer.style.display = 'block';
                    actions.style.display = 'block';
                    actions.querySelector('.btn-success').disabled = false;

                    discoveredSkills.forEach(skillName => {
                        const li = document.createElement('li');
                        li.style.padding = "5px 0";
                        li.style.borderBottom = "1px solid #eee";
                        const isCritical = skillName.trim().endsWith('(C)');
                        const criticalBadge = isCritical ? '<span style="background:#dc3545; color:white; font-size:10px; padding:2px 4px; border-radius:3px; margin-left:5px;">Critical</span>' : '';
                        li.innerHTML = `<span style="color:#333;">${skillName}</span> ${criticalBadge}`;
                        list.appendChild(li);
                    });
                }
            } catch (e) {
                loading.style.display = 'none';
                showToast("Error scanning OSM: " + e.message, "error");
                closeModal('osmImportModal');
            }
        }

        async function confirmOsmImport() {
            if (!discoveredSkills || discoveredSkills.length === 0) return;
            if (!confirm(`Import ${discoveredSkills.length} new skills?`)) return;

            const importPayload = discoveredSkills.map(name => ({
                name: name,
                url: "",
                critical_skill: name.trim().endsWith('(C)'),
                enabled: true // Default enabled on import
            }));

            try {
                const res = await fetch('/api/skills/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(importPayload)
                });

                if (res.ok) {
                    closeModal('osmImportModal');
                    await reloadSkills();
                    showToast(`Successfully imported ${importPayload.length} skills.`, 'success');
                } else {
                    throw new Error("Server rejected import.");
                }
            } catch (e) {
                showToast("Import failed: " + e.message, "error");
            }
        }

        initPage();
        window.onclick = (e) => {
            if (e.target == skillModal) closeModal('skillModal');
            if (e.target == document.getElementById('helpModal')) closeModal('helpModal');
            if (e.target == document.getElementById('osmImportModal')) closeModal('osmImportModal');
        }
        window.onscroll = function () { document.getElementById("scrollTopBtn").style.display = (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) ? "flex" : "none"; };
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
    </script>
    <script src="help.js"></script>
    <script src="theme.js"></script>
    <script src="toast.js"></script>
</body>

</html>